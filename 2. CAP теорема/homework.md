# CAP теорема

**CAP-теорема** — утверждение о том, что в распределённых системах нельзя одновременно добиться трёх свойств:

* **C**onsistency — на всех *не отказавших* узлах одинаковые (с точки зрения пользователя) данные  
* **A**vailability — запросы ко всем *не отказавшим* узлам возвращают ответ  
* **P**artition tolerance — даже если связь в системе стала нестабильной (вплоть до разделения системы на куски), но узлы работают, то система в целом продолжает работать

Оригинальная формулировка — Brewer's Conjecture (2000), а формализовано в работе Gilbert & Lynch (2004). 


## Классификация алгоритмов

А вот алгоритмы, которые удовлетворяют хотя бы двум свойствам, можно нарисовать на диаграмма Венна:

![Distributed-cap](https://github.com/stalmer120/NoSQL/blob/main/png/CAP.drawio.png)

## PostgresQL

CAP теорема не очень подходит для отказоустйчивых кластеров PostgreSQL, больше подходит PACELC

Kак пример можно рассмотреть связку PostgreSQL+Patroni+VIP-manager

![Distributed-cap](https://github.com/stalmer120/NoSQL/blob/main/png/PostgresCluster.nosql.drawio.png)

HA cluster PostgreSQL на patroni относится к системам, которые стремятся обеспечить высокую доступность и устойчивость к разделению сети. Это значит, что они могут временно терять согласованность данных для поддержания высокой доступности и восстанавливать согласованность при возможности. VIP-manager обеспечивает доступность.

## MongoDB

Нельзя просто сказать, что MongoDB — это CP/AP/CA, потому что на самом деле это компромисс между C, A и P, в зависимости от конфигурации базы данных/драйвера и типа катастрофы : 

| Сценарий | Основной фокус | Описание |
| ----- | ----- | ----- |
| No partition | CA | Система доступна и обеспечивает высокую согласованность |
| partition, majority connected | AP | Несинхронизированные записи со старого первичного сервера игнорируются. |
| partition, majority not connected | CP | предоставляется только доступ для чтения, чтобы избежать разрозненных и несогласованных систем |

### Consistency:

MongoDB строго согласована, когда вы используете одно соединение или правильный уровень проблем записи / чтения ( что будет стоить вам скорости выполнения ). Как только вы не соответствуете этим условиям (особенно когда вы читаете из вторичной реплики), MongoDB становится в конечном итоге согласованной.

### Availability:

MongoDB получает высокую доступность через Replica-Sets . Как только первичный сервер выходит из строя или становится недоступным, вторичные серверы определяют, какой новый первичный сервер снова станет доступным. В этом есть недостаток: каждая запись, выполненная старым первичным сервером, но не синхронизированная с вторичными серверами, будет откачена и сохранена в файле отката, как только он снова подключится к набору (старый первичный сервер теперь является вторичным). Таким образом, в этом случае некоторая согласованность приносится в жертву доступности.

### Partition Tolerance:

Благодаря использованию указанных Replica-Sets MongoDB также достигает толерантности к разделению: пока более половины серверов Replica-Set подключены друг к другу, можно выбрать новый основной сервер. Почему? Чтобы гарантировать, что две разделенные сети не могут обе выбрать новый основной сервер. Когда недостаточно вторичных серверов подключены друг к другу, вы все равно можете читать с них (но согласованность не гарантируется), но не писать. Набор практически недоступен ради согласованности.




## Cassandra

CAP-теорема (также известная как теорема Бэрри Бёрнса) утверждает, что в распределенных системах невозможно одновременно обеспечить три свойства: **Согласованность (Consistency)**, **Доступность (Availability)** и **Терпимость к разделению (Partition Tolerance)**. Любая система может гарантировать лишь два из трех свойств.

Вот как относятся к CAP-теореме перечисленные базы данных:

1. **PostgreSQL**:
   - **Тип**: CP (Согласованность и Терпимость к разделению)
   - **Обоснование**: PostgreSQL — это реляционная СУБД, которая обеспечивает высокую степень согласованности данных за счет использования транзакций ACID. При этом, в случае сетевого разделения, система может приостановить доступность, чтобы сохранить согласованность данных. Выбор в пользу согласованности над доступностью делает его CP-системой.

2. **MongoDB**:
   - **Тип**: AP (Доступность и Терпимость к разделению)
   - **Обоснование**: MongoDB — это документо-ориентированная NoSQL база данных, которая обеспечивает высокую доступность благодаря репликации. В условиях сетевого разделения MongoDB может продолжать принимать запросы на запись, даже если это означает возможные расхождения данных между репликами. Поэтому, MongoDB более склонна к обеспечению доступности и терпимости к разделениям, в результате чего она относится к AP-системам.

3. **Cassandra**:
   - **Тип**: AP (Доступность и Терпимость к разделению)
   - **Обоснование**: Cassandra является распределенной NoSQL базой данных, которая проектировалась для поддержки высокой доступности и масштабируемости. Она использует механизм eventual consistency (достижимость конечной согласованности), что позволяет системе оставаться доступной даже во время сетевых разделений. Поэтому Cassandra также рассматривается как AP-система, которая жертвует строгой согласованностью для достижения высокой доступности и отказоустойчивости.

В общем, выбор системы часто зависит от конкретных требований вашего приложения, таких как необходимость в согласованности, доступности или масштабируемости.
