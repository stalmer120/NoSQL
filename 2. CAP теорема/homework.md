# CAP теорема

**CAP-теорема** — утверждение о том, что в распределённых системах нельзя одновременно добиться трёх свойств:

* **C**onsistency — на всех *не отказавших* узлах одинаковые (с точки зрения пользователя) данные  
* **A**vailability — запросы ко всем *не отказавшим* узлам возвращают ответ  
* **P**artition tolerance — даже если связь в системе стала нестабильной (вплоть до разделения системы на куски), но узлы работают, то система в целом продолжает работать

Оригинальная формулировка — Brewer's Conjecture (2000), а формализовано в работе Gilbert & Lynch (2004). 


## Классификация алгоритмов

Алгоритмы, которые удовлетворяют хотя бы двум свойствам, можно нарисовать на диаграмма Венна:

![Distributed-cap](https://github.com/stalmer120/NoSQL/blob/main/png/CAP.drawio.png)

## PostgresQL

Если брать классический отказоустойчивый кластер PostgreSQL (Мастер-Реплика), то это СА (Согласованность и Доступность), но если рассмотреть более сложные системы.

Kак пример связку PostgreSQL+Patroni+ETCD+VIP-manager еще добавть сервер бэкапов на PgBackRest который хранит и WAL-архивы. С одной стороны, есть CAP теорема, которая накладывает теоретические ограничения на возможности построения HA-решений, с другой — математически доказанные алгоритмы определения консенсуса, например Raft, который используется в ETCD.

![Distributed-cap](https://github.com/stalmer120/NoSQL/blob/main/png/PostgresCluster.nosql.drawio.png)

## MongoDB

По умолчанию относится к CP (согласованность и устойчивость к разделам), Модель согласованности MongoDB довольно гибкая, что означает, что можно настроить ее в соответствии с конкретными потребностями своего приложения, балансируя согласованность, доступность и устойчивость к разделам таким образом, который лучше всего подходит для использования.

## Cassandra

Относится к AP (Доступность и Терпимость к разделению)

Cassandra является распределенной NoSQL базой данных, которая проектировалась для поддержки высокой доступности и масштабируемости. Она использует механизм eventual consistency (достижимость конечной согласованности), что позволяет системе оставаться доступной даже во время сетевых разделений. Поэтому Cassandra также рассматривается как AP-система, которая жертвует строгой согласованностью для достижения высокой доступности и отказоустойчивости.
