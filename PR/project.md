# **Сравнение etcd и Consul для хранения конфигурационных данных HA решений Postgresql**

## **Введение**

etcd и Consul — это два популярных инструмента, используемых для распределенного хранения ключей-значений, координации сервисов и обеспечения консенсуса в распределенных системах. Оба инструмента широко применяются в микросервисных архитектурах и облачных инфраструктурах. В этом проекте мы сравним их основные характеристики, преимущества и недостатки, а также определим сценарии использования.  
---

## **1\. Основные характеристики**

### **etcd**

* **Тип системы**: Распределенное хранилище ключей-значений.  
* **Протокол консенсуса**: Raft.  
* **Интерфейс**: gRPC и HTTP/HTTPS API.  
* **Использование**: Хранение конфигураций, координация сервисов, распределенные блокировки.  
* **Интеграция**: Широко используется в Kubernetes для хранения состояния кластера.

  ### **Consul**

* **Тип системы**: Распределенное хранилище ключей-значений \+ Service Discovery \+ Health Checking.  
* **Протокол консенсуса**: Raft.  
* **Интерфейс**: HTTP/HTTPS API, DNS-интерфейс.  
* **Использование**: Service Discovery, Health Checking, распределенные конфигурации, mesh-сети.  
* **Интеграция**: Поддержка мульти-датацентров, интеграция с Nomad, Kubernetes и другими системами.

  ---

  ## **2\. Сравнение по ключевым параметрам**

  ### **Хранение данных**

* **etcd**: Оптимизирован для хранения ключей-значений с поддержкой транзакций и версионности.  
* **Consul**: Помимо ключей-значений, поддерживает Service Discovery и Health Checking, что делает его более универсальным.

  ### **Производительность**

* **etcd**: Высокая производительность для операций чтения и записи, особенно в рамках одного кластера.  
* **Consul**: Производительность может быть ниже из\-за дополнительных функций, таких как Health Checking и Service Discovery.

  ### **Масштабируемость**

* **etcd**: Легко масштабируется в рамках одного кластера, но сложнее в мульти-датацентровых сценариях.  
* **Consul**: Поддерживает мульти-датацентровые конфигурации из коробки, что делает его более гибким для крупных распределенных систем.

  ### **Надежность и отказоустойчивость**

* **etcd**: Высокая надежность благодаря протоколу Raft, но требует тщательной настройки для мульти-датацентровых сценариев.  
* **Consul**: Встроенная поддержка мульти-датацентров и автоматическое восстановление после сбоев.

  ### **Использование ресурсов**

* **etcd**: Эффективно использует ресурсы, но требует дополнительных инструментов для мониторинга и управления.  
* **Consul**: Более ресурсоемкий из\-за дополнительных функций, таких как Health Checking и Service Discovery.

  ---

  ## **3\. Сценарии использования**

  ### **etcd**

* Хранение конфигураций и состояния в Kubernetes.  
* Распределенные блокировки и координация сервисов.  
* Системы, требующие высокой производительности и низкой задержки.

  ### **Consul**

* Service Discovery в микросервисных архитектурах.  
* Health Checking и автоматическое восстановление сервисов.  
* Мульти-датацентровые конфигурации и mesh-сети.

  ---

  ## **4\. Преимущества и недостатки**

  ### **etcd**

* **Преимущества**:  
  * Высокая производительность и низкая задержка.  
  * Простота интеграции с Kubernetes.  
  * Поддержка транзакций и версионности.  
* **Недостатки**:  
  * Ограниченная поддержка мульти-датацентров.  
  * Требует дополнительных инструментов для мониторинга и управления.

    ### **Consul**

* **Преимущества**:  
  * Встроенная поддержка Service Discovery и Health Checking.  
  * Поддержка мульти-датацентровых конфигураций.  
  * Интеграция с различными системами оркестрации.  
* **Недостатки**:  
  * Более высокая ресурсоемкость.  
  * Сложность настройки и управления.  
 ---

## **5\. Заключение**

etcd и Consul — это мощные инструменты, каждый из которых подходит для определенных сценариев. etcd идеален для систем, требующих высокой производительности и простоты интеграции с Kubernetes, тогда как Consul лучше подходит для микросервисных архитектур с требованиями к Service Discovery, Health Checking и мульти-датацентровым конфигурациям.  
---

## **6\. Дополнительные материалы**

* [Официальная документация etcd](https://etcd.io/docs/)  
* [Официальная документация Consul](https://www.consul.io/docs)

# **Установка и настройка etcd и Consul (3 ноды)**


## **1\. Требования к инфраструктуре**

### **Аппаратные требования**

**Для работы etcd и Consul на трех нодах рекомендуется следующая конфигурация:**

| Параметр | Минимальные требования | Рекомендуемые требования |
| :---- | :---- | :---- |
| **CPU** | **2 ядра** | **4 ядра** |
| **RAM** | **2 ГБ** | **4–8 ГБ** |
| **Диски** | **SSD, 20 ГБ** | **SSD, 50 ГБ** |
| **Сеть** | **Низкая задержка (\<1 мс)** | **Низкая задержка (\<1 мс)** |

### **Программные требования**

* **ОС: Ubuntu 20.04 LTS или 22.04 LTS.**  
* **Доступ в интернет: Для загрузки пакетов.**  
* **Пользователь с правами sudo: Для выполнения команд установки и настройки.**

  ---

  ## **2\. Установка и настройка etcd**

  ### **Шаг 1: Установка etcd на всех нодах**

Обновите пакеты на всех нодах:
````bash
sudo apt update && sudo apt upgrade \-y  
````
Установите etcd:
````bash
sudo apt install etcd \-y
````
Настройка etcd

На каждой ноде редактируем (`/etc/default/etcd`)
````bash
vi /etc/default/etcd
````
Указываем для каждой ноды.
````bash
ETCD\_NAME="node1"
ETCD\_DATA\_DIR="/var/lib/etcd"
ETCD\_INITIAL\_CLUSTER="node1=http://\<IP\_NODE1\>:2380,node2=http://\<IP\_NODE2\>:2380,node3=http://\<IP\_NODE3\>:2380"
ETCD\_INITIAL\_ADVERTISE\_PEER\_URLS="http://\<IP\_NODE1\>:2380"
ETCD\_ADVERTISE\_CLIENT\_URLS="http://\<IP\_NODE1\>:2379"
ETCD\_LISTEN\_PEER\_URLS="http://0.0.0.0:2380"
ETCD\_LISTEN\_CLIENT\_URLS="http://0.0.0.0:2379"
ETCD\_INITIAL\_CLUSTER\_TOKEN="etcd-cluster"
ETCD\_INITIAL\_CLUSTER\_STATE="new"
````
Запуск etcd на всех нодах
````bash
sudo systemctl start etcd
sudo systemctl enable etcd
````
Проверяем статус кластера API V2 
````bash
etcdctl member list
````

   ---


### **Установка Consul**

**Возможны несколько вариантов установки**

**1\. Воспользоваться зеркалами, например от Yandex**
````bash
export consul_ver=1.20.1
wget https://hashicorp-releases.yandexcloud.net/consul/$consul_ver/consul_"$consul_ver"_linux_amd64.zip
unzip consul_$(consul_ver)_linux_amd64.zip
sudo cp ./consul /usr/bin/consul
````
**Если используется данный способ потребуется создать системного пользователя** 
````bash
sudo groupadd consul -r
sudo adduser --system --home /home/consul --no-create-home --shell /bin/false --group consul
````
**Дополнительно потребуется создать unit файл по пути /lib/systemd/system/consul.service** 

````bash
[Unit]
Description="HashiCorp Consul - A service mesh solution"
Documentation=https://www.consul.io/
Requires=network-online.target
After=network-online.target
ConditionFileNotEmpty=/etc/consul.d/consul.hcl
 
[Service]
Type=notify
EnvironmentFile=-/etc/consul.d/consul.env
User=consul
Group=consul
ExecStart=/usr/bin/consul agent -config-dir=/etc/consul.d/
ExecReload=/bin/kill --signal HUP $MAINPID
KillMode=process
KillSignal=SIGTERM
Restart=on-failure
LimitNOFILE=65536
 
[Install]
WantedBy=multi-user.target
````


**2\. Скачать бинарный файл с сайта Hashicorp (блокируется скачивание с РФ IP)**

````bash
export consul_ver=1.20.1
wget https://releases.hashicorp.com/consul/$consul_ver/consul_"$consul_ver"_linux_amd64.zip
unzip consul_$(consul_ver)_linux_amd64.zip
sudo cp ./consul /usr/bin/consul
````

**Данный способ аналогичен скачиванию с зеркала, поэтому потребуется создание пользователя и systemd unit файла, см выше**

**3\. Из репозитория HashiCorp (блокируется скачивание с РФ IP)**

````bash
wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install consul
````

**Вне зависимости от выбранного метода также необходимо установить пакет python3-consul для patroni**

**либо**   
````bash
sudo apt install python3-consul
````
**либо если используется pip для patroni**  
````bash
python3 \-m pip install patroni\[consul\]
````
### **Конфигурирование консул**

**У всех членов кластера должен быть общий параметр encrypt (base64 строка определенной длины).** 

* **Если кластер consul общий для нескольких postgresql, то идем на сервер консул и запрашиваем какой ключ шифрования используется и его используем в качестве параметра encrypt**

````bash
consul-node1:~/$ consul keyring -list
````

* **Если кластер consul только для одного кластера postgresql, генерируем строку на любой ноде и используем ее для всех серверов как параметр encrypt**
````bash

pg-node1:~/$ consul keygen
````
**По пути /etc/consul.d/consul.hcl создаем или редактируем файл настроек**

**/etc/consul.d/consul.hcl**
````
node_name = "pg-node1"
ports = {
  dns = -1
  http = 8500
  https = -1
  grpc = -1
  grpc_tls = -1
  server = 8300
  serf_lan = 8301
  serf_wan = 8302
}
telemetry = {
  disable_hostname = true
  prometheus_retention_time = "30s"
}
performance = {
  raft_multiplier = 3
}
data_dir = "/app/consul"
client_addr = "127.0.0.1 192.168.0.91"
server = true
bootstrap_expect=3
bind_addr = "192.168.0.91"
 
encrypt = "EKmQq92T3RZwjc0rh+h/TjxSHO4zlw09vgsdSNtnXP0="
 
retry_join = ["pg-node1", "pg-node2", "pg-node3"]
````

**где**

* **node\_name \- установить в соответствии со значением hostname текущей виртуалки**  
* **prots \- рекомендуется оставить в таком формате, (см раздел с требованиями и описанием портов выше)**  
* **telemetry \- заполнить в соответствии с примером, если используется мониторинг через prometeus (может не работать или работать иначе в версиях с consul ниже 1.10)**  
* **performance \- смотри раздел Отказоустойчивость**   
* **data\_dir \- указать путь до каталога на который будут писаться данные consul, данный каталог уже должен существовать на момент запуска сервиса**  
* **clent\_addr \- какие адреса слушать по порту 8500, начиная с версии consul 1.0 можно указывать несколько адресов через пробел (для некоторых утилит нужно прослушивать localhost)**  
* **server \- будет ли консул работать в режиме сервера (server \= true) или агента (убрать данный параметр), *Следует убрать этот параметр если настраиваем агент который подключается к общему кластеру Consul*(схема разворачивания 1\)**   
* **bootstrap\_expect \- сколько нод ожидать для инициализации, также *удаляем этот параметр, если конфигурируем консул как агент***  
* **bind\_addr \- только один адрес, который consul будет использовать для взаимодействия с другими узлами**   
* **encrypt \- строка, общая для всех узлов кластера, описание в этом же разделе чуть выше**   
* **retry\_join \- массив из узлов кластера (если кластер выделенный \- узлы кластера postgres включая арбитр, если кластер общий \- узлы выделенного кластера)**

### **Запуск консул**

**На всех нодах кластера выполняем** 
````bash
sudo systemc start consul
sudo systemctl enable consul
sudo systemctl status consul
````
**Когда служба запустилась проверяем статус кластера** 
````bash
# Выведет список всех узлов кластера
consul members
# Выведет статус серверов с ролью consul server
consul operator raft list-peers
````
# **Выбор etcd vs Consul**
## **Врамках одного ЦОД**

**Для одного кластера HA на базе patroni**  

Предпочтение отдаем ETCD т.к. при монтировании отдельного диска (SSD,NVME) есть возможность устанвки прямо на машину из HA кластера patroni, что существенно экономит ресурсы и лицензии.  

**Для нескольких кластеров HA на базе patroni**  

Предпочтение также отдаем ETCD т.к. затраты cpu ram для etcd ниже.  

## **Врамках двух ЦОД**
![etcd_consul](https://github.com/stalmer120/NoSQL/blob/main/png/etcd_consul.png)

Здесь выбор падает на consul в конфигурации multi datacenter, для ETCD нужно поддерживать нечетное количество не только нод, но и ЦОД. При падении ЦОД1 в ЦОД2 ETCD не придут к консенсус т.к. осталось только 2 ноды из 5. Решение добавление в ЦОД2 еще одой машины в кластер с ETCD и удаление 1 машины ЦОД1 из кластера. Решение сложное, плюс потребуется доп. действия при восстановлении.  
## **Врамках трех ЦОД**
Предпочтение также отдаем ETCD т.к. затраты cpu ram для etcd ниже.
# **Вывод**  

Для работы в рамках одного ЦОД или трех выбор падает на ETCD, для двух ЦОД Consul
